<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Original British Cinema Quad Posters for Sale – Cinema Quad Posters</title>
    <meta name="description" content="Browse and buy authentic original British quad movie posters from classics to modern reissues.">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="cqp.css">

    <link rel="preload" href="inventory.json" as="fetch" crossorigin>
</head>

<body class="bg-black text-white">

<!-- NAVBAR -->
<nav class="navbar bg-dark navbar-dark sticky-top px-3">
    <div class="container-fluid navbar-grid">

        <!-- LEFT: Logo -->
        <div class="navbar-left">
            <a class="navbar-brand" href="shop.html">
                <img src="img/logo_2023.png"
                     alt="Cinema Quad Posters"
                     style="height:40px;">
            </a>
        </div>

        <!-- CENTER: Search + Filters -->
        <div class="navbar-center">
            <div class="navbar-search-group d-flex align-items-center gap-2">

                <!-- Search -->
                <input id="searchInput"
                       class="form-control form-control-sm search-pill"
                       placeholder="Search posters…">

                <!-- Browse -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-light dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown">
                        Browse
                    </button>
                    <div class="dropdown-menu dropdown-menu-dark p-3" style="min-width:220px">
                        <label class="small text-muted mb-1">Decade</label>
                        <select id="decadeFilter" class="form-select form-select-sm mb-2">
                            <option value="">All Decades</option>
                        </select>

                        <label class="small text-muted mb-1">Genre</label>
                        <select id="genreFilter" class="form-select form-select-sm">
                            <option value="">All Genres</option>
                        </select>
                    </div>
                </div>

                <!-- Sort -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-light dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown">
                        Sort
                    </button>
                    <div class="dropdown-menu dropdown-menu-dark p-2">
                        <select id="sortBy" class="form-select form-select-sm">
                            <option value="title">A–Z</option>
                            <option value="year-desc">Newest Release</option>
                            <option value="year-asc">Oldest Release</option>
                            <option value="price-asc">Price Low–High</option>
                            <option value="price-desc">Price High–Low</option>
                            <option value="recent-desc">Recently Added</option>
                            <option value="director">Director A–Z</option>
                        </select>
                    </div>
                </div>

            </div>
        </div>

        <!-- RIGHT: Shop + Cart -->
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="shop.html">Shop</a>
            <a href="cart.html" class="nav-link cart-link">
            <i class="bi bi-cart3"></i>
            <span id="cartCount" class="cart-badge">0</span>
            </a>
        </div>


    </div>
</nav>



<!-- GRID -->
<div class="container mt-3">
    <div id="results"
         class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    </div>
</div>


<!-- SCRIPT -->
<script>
let posters = [];
let uniqueDecades = [];
let uniqueGenres = [];
let uniqueDirectors = [];

// Pagination variables
let itemsPerPage = 40;
let currentOffset = 0;
let filteredPosters = [];
let isLoadingMore = false;

/* Load inventory and populate dynamic options */
fetch('inventory.json')
    .then(r => r.json())
    .then(data => {
        posters = data;

        // Collect unique decades
        const decadesSet = new Set();
        posters.forEach(p => {
            if (p['originally released']) {
                const decade = Math.floor(p['originally released'] / 10) * 10 + 's';
                decadesSet.add(decade);
            }
        });
        uniqueDecades = Array.from(decadesSet).sort();

        // Collect unique genres
        const genresSet = new Set();
        posters.forEach(p => {
            if (Array.isArray(p.genre)) {
                p.genre.forEach(g => genresSet.add(g));
            } else if (p.genre) {
                genresSet.add(p.genre);
            }
        });
        uniqueGenres = Array.from(genresSet).sort();

        // Collect unique directors
        const directorsSet = new Set();
        posters.forEach(p => {
            if (p.director) directorsSet.add(p.director);
        });
        uniqueDirectors = Array.from(directorsSet).sort();

        // Populate decade options
        const decadeSelect = document.getElementById('decadeFilter');
        decadeSelect.innerHTML = '<option value="">All Decades</option>';
        uniqueDecades.forEach(d => {
            decadeSelect.innerHTML += `<option value="${d}">${d}</option>`;
        });

        // Populate genre options
        const genreSelect = document.getElementById('genreFilter');
        genreSelect.innerHTML = '<option value="">All Genres</option>';
        uniqueGenres.forEach(g => {
            genreSelect.innerHTML += `<option value="${g}">${g}</option>`;
        });

        // Populate director options if you have it (optional)
        // ...

        render(true); // Initial render
        setupInfiniteScroll();
    })
    .catch(error => {
        console.error('Error loading inventory:', error);
        document.getElementById('results').innerHTML = '<p class="text-center text-muted mt-4">Error loading posters. Please try again later.</p>';
    });

/* Debounce for search */
function debounce(func, delay) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => func(...args), delay);
    };
}

/* Render function */
function render(reset = true) {
    const r = document.getElementById('results');
    if (reset) {
        currentOffset = 0;
        r.innerHTML = '';
    }

    let filteredPosters = posters;

    // Search
    const search = document.getElementById('searchInput')?.value.toLowerCase();
    if (search) {
        filteredPosters = filteredPosters.filter(p =>
            p.title.toLowerCase().includes(search) ||
            p.director?.toLowerCase().includes(search) ||
            p.actors?.some(a => a.toLowerCase().includes(search)) ||
            p.genre?.some(g => g.toLowerCase().includes(search))
        );
    }

    // Decade
    const decade = document.getElementById('decadeFilter')?.value;
    if (decade) {
        filteredPosters = filteredPosters.filter(p => p['originally released'] && Math.floor(p['originally released'] / 10) * 10 == decade);
    }

    // Genre
    const genre = document.getElementById('genreFilter')?.value;
    if (genre) {
        filteredPosters = filteredPosters.filter(p => p.genre?.includes(genre));
    }

    // Sort
    const sortBy = document.getElementById('sortBy')?.value || 'title';
    filteredPosters.sort((a, b) => {
        if (sortBy === 'title') return a.sort_title.localeCompare(b.sort_title);
        if (sortBy === 'year-desc') return (b['originally released'] || 0) - (a['originally released'] || 0);
        if (sortBy === 'year-asc') return (a['originally released'] || 0) - (b['originally released'] || 0);
        if (sortBy === 'price-asc') return a.price - b.price;
        if (sortBy === 'price-desc') return b.price - a.price;
        if (sortBy === 'recent-desc') return new Date(b.purchase_date || 0) - new Date(a.purchase_date || 0);
        if (sortBy === 'director') return a.director.localeCompare(b.director);
        return 0;
    });

    const BATCH_SIZE = 12; // Adjust for grid batch size (e.g., 12-24 for performance)
    const batch = filteredPosters.slice(currentOffset, currentOffset + BATCH_SIZE);

    let html = '';
    try {
        html = batch.map(x => {
            if (!x || !x.title) throw new Error('Invalid poster data');
            const slug = x.title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-+|-+$/g, '');
            return `
                <div class="col-6 col-sm-4 col-md-3 mb-4">
                    <a href="static-posters/${slug}.html" class="poster-card position-relative">
                        ${x.on_sale ? '<span class="sale-badge">SALE</span>' : ''}
                        <img src="${x.thumbnail}" alt="${x.title} poster" loading="lazy" style="max-width: 100%; height: auto;">
                        <div class="poster-label">
                            <h5 class="card-title">${x.title}</h5>
                            <span class="price">£${x.price.toFixed(2)}</span>
                        </div>
                    </a>
                </div>`;
        }).join('');
    } catch (e) {
        console.error('Render map error:', e);
        html = '<p class="text-muted">Error rendering posters - check console for details.</p>';
    }
    r.innerHTML += html;

    currentOffset += batch.length;
    isLoadingMore = false;

    if (currentOffset < filteredPosters.length) {
        addSentinel();
    }
}

// Function to add sentinel for infinite scroll
function addSentinel() {
    const r = document.getElementById('results');
    const sentinel = document.createElement('div');
    sentinel.id = 'sentinel';
    sentinel.style.height = '1px';
    r.appendChild(sentinel);

    const observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting && !isLoadingMore) {
            isLoadingMore = true;
            observer.disconnect();
            document.getElementById('sentinel')?.remove();
            render(false);
        }
    }, { rootMargin: '200px' });

    observer.observe(sentinel);
}

// Setup infinite scroll
function setupInfiniteScroll() {
    // Initial sentinel handled in render
}

/* Event listeners */
const inputs = ['searchInput', 'decadeFilter', 'genreFilter', 'sortBy'];
inputs.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', () => {
            if (id === 'searchInput') {
                debounce(() => render(true), 300)();
            } else {
                render(true);
            }
        });
    }
});

/* Cart count */
function updateCartCount(animate = false) {
    const badge = document.getElementById('cartCount');
    if (badge && typeof Snipcart !== 'undefined') {
        const count = Snipcart.store.getState().cart.items.length;
        badge.textContent = count;
        if (animate) {
            badge.classList.add('animate');
            setTimeout(() => badge.classList.remove('animate'), 300);
        }
    }
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- FOOTER -->
<footer class="site-footer mt-5">
    <div class="container py-4">
        <div class="row gy-3 align-items-center">

            <div class="col-md-4 footer-left">
                <a href="shop.html">
                    <img src="img/logo.png"
                         alt="Cinema Quad Posters"
                         class="footer-logo">
                </a>
            </div>

            <div class="col-md-4 text-center">
                <ul class="footer-links justify-content-center mb-1">
                    <li><a href="shop.html">Shop</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="faq.html">FAQs</a></li>
                    <li><a href="terms.html">Terms</a></li>
                </ul>
                <p class="small mb-0" style="color: #aaa;">    
                    © <span id="year"></span> Cinema Quad Posters
                </p>
            </div>

        </div>
    </div>
</footer>


<script>
document.getElementById('year').textContent = new Date().getFullYear();
</script>

<script src="cqp.js"></script>


</body>
</html>