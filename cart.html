<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cart – Cinema Quad Posters</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="cqp.css">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DCT6EGE8PB"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-DCT6EGE8PB');
    </script>

</head>
<body class="bg-black text-white">
    <!-- Navbar (as before, without Snipcart) -->
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark sticky-top px-3">
        <div class="container-fluid">
            <a href="shop.html" class="me-4">
                <img src="img/logo_2023.png" alt="Cinema Quad Posters" style="height:40px;">
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="shop.html">Shop</a>
                <a class="nav-link cart-link" href="cart.html">
                    <i class="bi bi-cart3"></i>
                    <span id="cartCount" class="cart-badge">0</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h2>Your Cart</h2>
        <div id="cartItems" class="list-group"></div>
        
        <!-- Shipping Options -->
        <div class="mt-4">
            <p class="text-muted">Please choose a postage option before checkout:</p>
            <select id="shippingOption" class="form-select form-select-lg bg-dark text-white border-secondary">
                <option value="">Select Postage...</option>
                <option value="uk">UK Postage (£10.00)</option>
                <option value="europe">Europe Postage (£20.00)</option>
                <option value="worldwide">Worldwide Postage (£30.00)</option>
            </select>
        </div>
        
        <div class="cart-summary mt-4 text-end">
            <strong>Total:</strong> <span id="cartTotal" class="text-warning fw-bold">£0.00</span>
        </div>
        <button id="checkoutBtn" class="btn btn-warning btn-lg mt-3 text-dark fw-bold" disabled>Checkout</button>
    </div>

    <!-- Footer (as before) -->

    <script>
    // Shipping costs map (adjust as needed)
    const shippingCosts = {
        uk: 10.00,
        europe: 20.00,
        worldwide: 30.00
    };

    function renderCart() {
        const cartItemsEl = document.getElementById('cartItems');
        const cartTotalEl = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const shippingSelect = document.getElementById('shippingOption');
        const cart = getCart();

        cartItemsEl.innerHTML = '';
        if (!cart.length) {
            cartItemsEl.innerHTML = '<p class="text-muted">Your cart is empty.</p>';
            cartTotalEl.textContent = '£0.00';
            checkoutBtn.disabled = true;
            shippingSelect.disabled = true; // Disable shipping if cart empty
            return;
        }

        shippingSelect.disabled = false; // Enable shipping if cart has items

        let itemsTotal = 0;
        cart.forEach(item => {
            itemsTotal += item.price;
            const itemEl = document.createElement('div');
            itemEl.className = 'cart-item list-group-item bg-dark border-0';
            itemEl.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="${item.thumbnail}" alt="${item.title}" class="cart-thumb">
                        <span class="cart-title">${item.title}</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="cart-price me-3">£${item.price.toFixed(2)}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${item.id}'); renderCart();">Remove</button>
                    </div>
                </div>
            `;
            cartItemsEl.appendChild(itemEl);
        });

        // Update total with items + shipping
        const selectedShipping = shippingSelect.value;
        const shippingCost = selectedShipping ? shippingCosts[selectedShipping] : 0;
        const total = itemsTotal + shippingCost;
        cartTotalEl.textContent = `£${total.toFixed(2)}`;

        // Enable checkout only if shipping selected and cart not empty
        checkoutBtn.disabled = !selectedShipping;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const shippingSelect = document.getElementById('shippingOption');
        shippingSelect.addEventListener('change', renderCart); // Re-render on shipping change

        renderCart(); // Initial render

        const checkoutBtn = document.getElementById('checkoutBtn');
        if (checkoutBtn) {
            checkoutBtn.addEventListener('click', async () => {
                const selectedShipping = document.getElementById('shippingOption').value;
                if (!selectedShipping) {
                    alert('Please choose a postage option before checkout.');
                    return;
                }

                const cart = getCart();
                if (!cart.length) return;

                try {
                    const response = await fetch('/.netlify/functions/create-checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: cart, shipping: selectedShipping })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const { sessionId } = await response.json();
                    const stripe = Stripe('pk_live_51SfRLFAn4nVEPNCV3ZzFQK4DXMEwONM7QjfQwnBxk8nISMl34qqOzi3kCS0tR9RgIQZSXERJyXSaxUfbIMX3ascV00J3kvpqpK'); // Your live/test publishable key
                    const { error } = await stripe.redirectToCheckout({ sessionId });
                    if (error) {
                        alert('Stripe error: ' + error.message);
                    }
                } catch (error) {
                    console.error('Checkout error:', error);
                    alert('Error starting checkout: ' + error.message);
                }
            });
        }
    });
    </script>

    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe JS for redirect -->
    <script src="cqp.js"></script> <!-- Your shared cart utils -->
</body>
</html>